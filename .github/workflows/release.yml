name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  APP_NAME: UnclutterPlus
  BUILD_PATH: .build/release

permissions:
  contents: write
  
jobs:
  build-and-release:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Build Release
      run: |
        echo "Building ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}"
        swift build -c release --arch arm64 --arch x86_64
        
    - name: Create App Bundle
      run: |
        # åˆ›å»ºåº”ç”¨åŒ…ç»“æž„
        mkdir -p "${{ env.APP_NAME }}.app/Contents/MacOS"
        mkdir -p "${{ env.APP_NAME }}.app/Contents/Resources"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ (æ£€æŸ¥é€šç”¨äºŒè¿›åˆ¶æž„å»ºè·¯å¾„)
        if [ -f ".build/apple/Products/Release/${{ env.APP_NAME }}" ]; then
          cp ".build/apple/Products/Release/${{ env.APP_NAME }}" "${{ env.APP_NAME }}.app/Contents/MacOS/"
        elif [ -f "${{ env.BUILD_PATH }}/${{ env.APP_NAME }}" ]; then
          cp "${{ env.BUILD_PATH }}/${{ env.APP_NAME }}" "${{ env.APP_NAME }}.app/Contents/MacOS/"
        else
          echo "âŒ Error: Cannot find executable file"
          find .build -name "${{ env.APP_NAME }}" -type f
          exit 1
        fi
        
        # å¤åˆ¶ Info.plist
        cp "Sources/${{ env.APP_NAME }}/Info.plist" "${{ env.APP_NAME }}.app/Contents/"
        
        # å¤åˆ¶å›¾æ ‡æ–‡ä»¶
        if [ -f "Sources/${{ env.APP_NAME }}/Resources/${{ env.APP_NAME }}.icns" ]; then
          cp "Sources/${{ env.APP_NAME }}/Resources/${{ env.APP_NAME }}.icns" "${{ env.APP_NAME }}.app/Contents/Resources/"
          echo "âœ… App icon included"
        else
          echo "âš ï¸  Warning: No app icon found"
        fi
        
        # æ›´æ–° Info.plist ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.VERSION }}" "${{ env.APP_NAME }}.app/Contents/Info.plist"
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.VERSION }}" "${{ env.APP_NAME }}.app/Contents/Info.plist"
        
        # è®¾ç½®å¯æ‰§è¡Œæƒé™
        chmod +x "${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}"
        
        echo "App bundle created successfully"
        ls -la "${{ env.APP_NAME }}.app/Contents/"
        
    - name: Code Sign (Optional)
      run: |
        # å¦‚æžœæœ‰å¼€å‘è€…è¯ä¹¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œä»£ç ç­¾å
        # codesign --force --deep --sign "Developer ID Application: Your Name" "${{ env.APP_NAME }}.app"
        echo "Skipping code signing (add your certificate if needed)"
        
    - name: Create DMG
      run: |
        # åˆ›å»ºä¸´æ—¶ DMG ç›®å½•
        mkdir -p dmg-temp
        cp -R "${{ env.APP_NAME }}.app" dmg-temp/
        
        # åˆ›å»º DMG
        hdiutil create -size 200m -fs HFS+ -volname "${{ env.APP_NAME }}" temp.dmg
        hdiutil attach temp.dmg -mountpoint /Volumes/${{ env.APP_NAME }}
        
        # å¤åˆ¶åº”ç”¨åˆ° DMG
        cp -R dmg-temp/* "/Volumes/${{ env.APP_NAME }}/"
        
        # åˆ›å»º Applications æ–‡ä»¶å¤¹çš„ç¬¦å·é“¾æŽ¥
        ln -s /Applications "/Volumes/${{ env.APP_NAME }}/Applications"
        
        # å¸è½½ä¸´æ—¶ DMG
        hdiutil detach "/Volumes/${{ env.APP_NAME }}"
        
        # åˆ›å»ºæœ€ç»ˆçš„åŽ‹ç¼© DMG
        hdiutil convert temp.dmg -format UDZO -o "${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm temp.dmg
        rm -rf dmg-temp
        
        echo "DMG created successfully"
        ls -la *.dmg
        
    - name: Create Release Archive
      run: |
        # åˆ›å»ºæºä»£ç å½’æ¡£
        git archive --format=zip --prefix="${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}/" HEAD > "${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-source.zip"
        
        # åˆ›å»ºäºŒè¿›åˆ¶å½’æ¡£
        zip -r "${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos.zip" "${{ env.APP_NAME }}.app"
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        # ä»Ž CHANGELOG.md æå–å‘å¸ƒè¯´æ˜Ž
        if [[ -f "CHANGELOG.md" ]]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„å‘å¸ƒè¯´æ˜Ž
          VERSION_NUMBER="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER=${VERSION_NUMBER#v}  # ç§»é™¤ 'v' å‰ç¼€
          
          # æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬çš„éƒ¨åˆ†
          awk "/## \[$VERSION_NUMBER\]/{flag=1; next} /## \[/{if(flag) exit} flag" CHANGELOG.md > release_notes.txt
          
          # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°å½“å‰ç‰ˆæœ¬çš„è¯´æ˜Žï¼Œç”Ÿæˆé»˜è®¤å†…å®¹
          if [[ ! -s release_notes.txt ]]; then
            echo "## UnclutterPlus ${{ steps.version.outputs.VERSION }}" > release_notes.txt
            echo "" >> release_notes.txt
            echo "ä¸€æ¬¾çŽ°ä»£åŒ–çš„ macOS ç”Ÿäº§åŠ›åº”ç”¨ï¼Œçµæ„Ÿæ¥æºäºŽ Unclutterï¼Œæä¾›å¢žå¼ºçš„æ–‡ä»¶ç®¡ç†ã€å‰ªè´´æ¿åŽ†å²å’Œ Markdown ç¬”è®°åŠŸèƒ½ã€‚" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "### ä¸»è¦åŠŸèƒ½" >> release_notes.txt
            echo "- ðŸ—‚ï¸ **æ–‡ä»¶ç®¡ç†**: ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œæ”¯æŒæ‹–æ‹½æ“ä½œå’Œæ™ºèƒ½æ–‡ä»¶å›¾æ ‡" >> release_notes.txt
            echo "- ðŸ“‹ **å‰ªè´´æ¿åŽ†å²**: å¤šæ ¼å¼æ”¯æŒï¼Œæ™ºèƒ½æœç´¢ï¼ŒæŒä¹…åŒ–å­˜å‚¨" >> release_notes.txt
            echo "- ðŸ“ **Markdown ç¬”è®°**: å®žæ—¶é¢„è§ˆï¼Œè¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨ä¿å­˜" >> release_notes.txt
            echo "- ðŸ–¥ï¸ **ç³»ç»Ÿé›†æˆ**: å±å¹•è¾¹ç¼˜æ‰‹åŠ¿è§¦å‘ï¼Œå¤šå±å¹•æ”¯æŒï¼Œæµç•…åŠ¨ç”»" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "### ç³»ç»Ÿè¦æ±‚" >> release_notes.txt
            echo "- macOS 12.0 æˆ–æ›´é«˜ç‰ˆæœ¬" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "### å®‰è£…è¯´æ˜Ž" >> release_notes.txt
            echo "1. ä¸‹è½½ DMG æ–‡ä»¶" >> release_notes.txt
            echo "2. åŒå‡»æ‰“å¼€ï¼Œå°† UnclutterPlus æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹" >> release_notes.txt
            echo "3. å¯åŠ¨åº”ç”¨ï¼Œé¼ æ ‡ç§»è‡³å±å¹•é¡¶éƒ¨è¾¹ç¼˜å¹¶å‘ä¸‹æ»‘åŠ¨æˆ–æ»šè½®å³å¯æ¿€æ´»" >> release_notes.txt
          fi
        else
          echo "## ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}" > release_notes.txt
          echo "- æ–°ç‰ˆæœ¬å‘å¸ƒï¼ŒåŒ…å«æœ€æ–°åŠŸèƒ½å’Œæ”¹è¿›" >> release_notes.txt
        fi
        
        echo "Release notes:"
        cat release_notes.txt
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.TAG_NAME }}
        name: ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}
        body_path: release_notes.txt
        files: |
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-source.zip
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}
        path: |
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-source.zip
          ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos.zip
        retention-days: 30